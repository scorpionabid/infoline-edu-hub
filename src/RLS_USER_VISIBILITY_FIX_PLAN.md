# RLS User Visibility Fix Plan
## RegionAdmin-…ô T…ôyin Edilm…ômi≈ü ƒ∞stifad…ô√ßil…ôri G√∂rm…ôsini T…ômin Etm…ôk

### üìã Problem T…ôsviri

**M√∂vcud Problem:**
- RegionAdmin sektor admin t…ôyin ed…ôrk…ôn yalnƒ±z √∂z regionundakƒ± istifad…ô√ßil…ôri g√∂r√ºr
- He√ß bir regiona t…ôyin edilm…ômi≈ü istifad…ô√ßil…ôr RLS siyas…ôti s…ôb…ôbind…ôn g√∂r√ºnm√ºr
- Bu, yeni yaradƒ±lmƒ±≈ü istifad…ô√ßil…ôrin sector admin t…ôyin edilm…ôsini mane…ô t√∂r…ôdir

**T…ôsir Ed…ôn Komponentl…ôr:**
- `/src/components/sectors/SectorAdminDialogs/ExistingUserDialog/ExistingUserSectorAdminDialog.tsx`
- `/src/hooks/user/useUsers.ts`
- `/src/services/users/userFetchService.ts`

### üéØ H…ôll Strategiyasƒ±

Database s…ôviyy…ôsind…ô SECURITY DEFINER funksiya yaratmaq v…ô frontend-d…ô region-aware user fetch t…ôtbiq etm…ôk.

---

## üìù Implementation Plan

### Phase 1: Database Function Yaratma

#### Step 1.1: Supabase SQL Function Yaratmaq
**Fayl:** Supabase SQL Editor-d…ô icra edil…ôc…ôk
**Status:** ‚è≥ G√∂zl…ôyir

```sql
-- Regional admin √º√ß√ºn t…ôyin edil…ô bil…ôn istifad…ô√ßil…ôri qaytaran funksiya
CREATE OR REPLACE FUNCTION get_assignable_users_for_region(p_region_id uuid)
RETURNS TABLE (
  id uuid,
  full_name text, 
  email text,
  phone text,
  status text,
  role text,
  region_id uuid,
  sector_id uuid,
  school_id uuid,
  created_at timestamptz,
  updated_at timestamptz
)
SECURITY DEFINER
AS $$
BEGIN
  RETURN QUERY
  SELECT DISTINCT 
    p.id,
    p.full_name,
    p.email, 
    p.phone,
    p.status,
    COALESCE(ur.role, 'unassigned') as role,
    ur.region_id,
    ur.sector_id,
    ur.school_id,
    p.created_at,
    p.updated_at
  FROM profiles p
  LEFT JOIN user_roles ur ON p.id = ur.user_id
  WHERE 
    -- SuperAdmin-l…ôri istisna et
    COALESCE(ur.role, '') != 'superadmin'
    AND (
      -- √ñz regionundakƒ± istifad…ô√ßil…ôr
      ur.region_id = p_region_id 
      OR 
      -- He√ß bir regiona t…ôyin edilm…ômi≈ü istifad…ô√ßil…ôr
      ur.region_id IS NULL
      OR
      -- He√ß bir rolu olmayan istifad…ô√ßil…ôr
      ur.role IS NULL
    )
  ORDER BY p.full_name;
END;
$$ LANGUAGE plpgsql;
```

#### Step 1.2: Funksiyanƒ±n ƒ∞caz…ôl…ôrini Yoxlamaq
**Status:** ‚è≥ G√∂zl…ôyir

```sql
-- Test sorƒüusu - regionadmin kimi test etm…ôk
SELECT * FROM get_assignable_users_for_region('your-region-id-here');
```

### Phase 2: Backend Service Yenil…ônm…ôsi

#### Step 2.1: userFetchService-…ô Yeni Funksiya ∆èlav…ô Etm…ôk
**Fayl:** `/src/services/users/userFetchService.ts`
**Status:** ‚è≥ G√∂zl…ôyir

∆èlav…ô edil…ôc…ôk funksiya:
```typescript
async getAssignableUsersForRegion(regionId: string): Promise<FullUserData[]> {
  try {
    const { data, error } = await supabase.rpc('get_assignable_users_for_region', {
      p_region_id: regionId
    });

    if (error) {
      console.error('Error fetching assignable users:', error);
      throw error;
    }

    return data as FullUserData[];
  } catch (error) {
    console.error('Error in getAssignableUsersForRegion:', error);
    throw error;
  }
}
```

#### Step 2.2: userFetchService Export-larƒ±na ∆èlav…ô Etm…ôk
**Fayl:** `/src/services/users/userFetchService.ts`
**Status:** ‚è≥ G√∂zl…ôyir

```typescript
// Export new function
export const getAssignableUsersForRegion = userFetchService.getAssignableUsersForRegion;
```

### Phase 3: Hook Yenil…ônm…ôsi

#### Step 3.1: useUsers Hook-unu Region-Aware Etm…ôk
**Fayl:** `/src/hooks/user/useUsers.ts`
**Status:** ‚è≥ G√∂zl…ôyir

D…ôyi≈üiklikl…ôr:
- `useUsers` hook-una `regionId` parametri …ôlav…ô etm…ôk
- `regionId` m√∂vcud olduqda `getAssignableUsersForRegion` istifad…ô etm…ôk
- Query key-…ô `regionId` …ôlav…ô etm…ôk

#### Step 3.2: Yeni useAssignableUsers Hook Yaratmaq
**Fayl:** `/src/hooks/user/useAssignableUsers.ts` (Yeni Fayl)
**Status:** ‚è≥ G√∂zl…ôyir

```typescript
import { useQuery } from '@tanstack/react-query';
import { userFetchService } from '@/services/users/userFetchService';
import { FullUserData } from '@/types/user';

export const useAssignableUsers = (regionId?: string) => {
  const { data: users = [], isLoading, error, refetch } = useQuery({
    queryKey: ['assignable-users', regionId],
    queryFn: () => {
      if (!regionId) {
        return userFetchService.getAllUsers();
      }
      return userFetchService.getAssignableUsersForRegion(regionId);
    },
    enabled: !!regionId,
    staleTime: 5 * 60 * 1000, // 5 minutes
  });

  return {
    users,
    isLoading,
    error,
    refetch
  };
};
```

### Phase 4: Component Yenil…ônm…ôsi

#### Step 4.1: User Context Hook Yaratmaq
**Fayl:** `/src/hooks/auth/useUserRegion.ts` (Yeni Fayl)
**Status:** ‚è≥ G√∂zl…ôyir

ƒ∞stifad…ô√ßinin regionId-sini …ôld…ô etm…ôk √º√ß√ºn hook yaratmaq.

#### Step 4.2: ExistingUserSectorAdminDialog Yenil…ônm…ôsi
**Fayl:** `/src/components/sectors/SectorAdminDialogs/ExistingUserDialog/ExistingUserSectorAdminDialog.tsx`
**Status:** ‚è≥ G√∂zl…ôyir

D…ôyi≈üiklikl…ôr:
- `useUsers` …ôv…ôzin…ô `useAssignableUsers` istifad…ô etm…ôk
- Current user region ID-sini …ôld…ô etm…ôk
- Region ID-ni hook-a √∂t√ºrm…ôk

### Phase 5: Translation & UI Improvements

#### Step 5.1: Translation Key-l…ôri ∆èlav…ô Etm…ôk
**Fayl:** `/src/translations/az/sectors.ts`
**Status:** ‚è≥ G√∂zl…ôyir

```typescript
// ∆èlav…ô edil…ôc…ôk key-l…ôr:
unassignedUsers: 'T…ôyin edilm…ômi≈ü istifad…ô√ßil…ôr',
regionalUsers: 'Regional istifad…ô√ßil…ôr',
userCategory: 'ƒ∞stifad…ô√ßi kateqoriyasƒ±',
noAssignableUsers: 'T…ôyin edil…ô bil…ôn istifad…ô√ßi yoxdur'
```

#### Step 5.2: User Grouping UI ∆èlav…ô Etm…ôk
**Fayl:** `/src/components/sectors/SectorAdminDialogs/ExistingUserDialog/ExistingUserSectorAdminDialog.tsx`
**Status:** ‚è≥ G√∂zl…ôyir

ƒ∞stifad…ô√ßil…ôri kateqoriyalara ayƒ±rmaq:
- Regional istifad…ô√ßil…ôr
- T…ôyin edilm…ômi≈ü istifad…ô√ßil…ôr

### Phase 6: Testing & Validation

#### Step 6.1: Manual Testing
**Status:** ‚è≥ G√∂zl…ôyir

Test senaril…ôri:
1. RegionAdmin kimi giri≈ü etm…ôk
2. Sektor admin t…ôyin etm…ô dialog-unu a√ßmaq
3. H…ôm regional h…ôm d…ô t…ôyin edilm…ômi≈ü istifad…ô√ßil…ôrin g√∂r√ºnm…ôsini yoxlamaq
4. ƒ∞stifad…ô√ßi t…ôyin etm…ô …ôm…ôliyyatƒ±nƒ±n i≈ül…ôm…ôsini test etm…ôk

#### Step 6.2: Permission Testing
**Status:** ‚è≥ G√∂zl…ôyir

Test edil…ôc…ôk hallar:
- RegionAdmin A-nƒ±n RegionAdmin B-nin istifad…ô√ßil…ôrini g√∂rm…ôdiyini yoxlamaq
- SuperAdmin istifad…ô√ßil…ôrinin siyahƒ±da g√∂r√ºnm…ôdiyini yoxlamaq
- RLS siyas…ôtl…ôrinin d√ºzg√ºn i≈ül…ôdiyini yoxlamaq

### Phase 7: Documentation & Cleanup

#### Step 7.1: Code Documentation
**Status:** ‚è≥ G√∂zl…ôyir

- Yeni funksiyalarƒ±n TSDoc ≈ü…ôrhl…ôri
- Database funksiyasƒ±nƒ±n dokumentasiyasƒ±
- API documentation yenil…ônm…ôsi

#### Step 7.2: Performance Monitoring
**Status:** ‚è≥ G√∂zl…ôyir

- Database funksiyasƒ±nƒ±n performansƒ±nƒ± yoxlamaq
- Query execution plan analizi
- Lazy loading v…ô caching strategiyalarƒ±nƒ± n…ôz…ôrd…ôn ke√ßirm…ôk

---

## üìä Progress Tracking

### Status Legend
- ‚è≥ **G√∂zl…ôyir** - Ba≈ülanmayƒ±b
- üü° **Davam edir** - ƒ∞≈ül…ônilir
- ‚úÖ **Tamamlandƒ±** - Bitib v…ô test edilib
- ‚ùå **Problem** - D√ºz…ôli≈ü t…ôl…ôb edir

### Current Status: SUCCESSFULLY IMPLEMENTED AND WORKING
**Son yenil…ônm…ô:** 29 ƒ∞yun 2025 - 12:16

#### ‚úÖ Phase 1: Database Function Yaratma - TAMAMLANDI V∆è TEST EDƒ∞LDƒ∞
- SQL funksiya UƒûURLA yaradƒ±ldƒ±: `get_assignable_users_for_region`
- ENUM problem h…ôll edildi (role::text cast)
- Test edildi: 100 istifad…ô√ßi d√ºzg√ºn filtrl…ônir
- N…ôtic…ôl…ôr: regionadmin, sectoradmin, NULL role istifad…ô√ßil…ôri

#### ‚úÖ Phase 2: Backend Service Yenil…ônm…ôsi - TAMAMLANDI
- `userFetchService.ts`-…ô `getAssignableUsersForRegion` …ôlav…ô edildi
- Export funksiyalarƒ± yenil…ôndi
- Supabase RPC √ßaƒüƒ±rƒ±≈üƒ± i≈ül…ôyir
- Debug logging …ôlav…ô edildi

#### ‚úÖ Phase 3: Hook Yenil…ônm…ôsi - TAMAMLANDI
- `useAssignableUsers.ts` hook yaradƒ±ldƒ± v…ô test edildi
- React Query inteqrasƒÉ√ºn«ñ i≈ül…ôyir
- Fallback strategiyasƒ± t…ôtbiq edildi
- Error handling t…ôkmill…ô≈üdirildi

#### ‚úÖ Phase 4: User Context Hook - TAMAMLANDI
- `useUserRegion.ts` hook yaradƒ±ldƒ±
- Current user region ID d√ºzg√ºn …ôld…ô edilir
- Auth context inteqrasiyasƒ± i≈ül…ôyir

#### ‚úÖ Phase 5: Component Yenil…ônm…ôsi - TAMAMLANDI V∆è TEST EDƒ∞LDƒ∞
- `ExistingUserSectorAdminDialog.tsx` tam yenil…ôndi
- Yeni hook-larƒ±n istifad…ôsi t…ôtbiq edildi
- UI/UX t…ôkmill…ô≈üdirilm…ôl…ôri tamamlandƒ±
- Debug m…ôlumatlarƒ± i≈ül…ôyir
- Console log: "Successfully fetched assignable users: count: 100"

#### ‚úÖ Phase 6: Translation & UI Improvements - TAMAMLANDI
- Translation key-l…ôri …ôlav…ô edildi (`sectors.ts`)
- User feedback m…ôsajlarƒ± yenil…ôndi
- Loading states t…ôkmill…ô≈üdirildi

#### üéØ FINAL TEST RESULTS - SUCCESS!
- Database function d√ºzg√ºn i≈ül…ôyir
- RegionAdmin √∂z regionundakƒ± v…ô t…ôyin edilm…ômi≈ü istifad…ô√ßil…ôri g√∂r√ºr
- Filtirl…ôm…ô d√ºzg√ºn i≈ül…ôyir (100 istifad…ô√ßi …ôv…ôzin…ô 369-un)
- SuperAdmin-l…ôr filtrl…ônir
- Frontend fallback strategiyasƒ± hazƒ±r

### Implementation Order
1. **Database Function** (∆èn kritik)
2. **Backend Service** 
3. **Hook Yenil…ônm…ôsi**
4. **Component Integration**
5. **Testing & Validation**

---

## üöÄ Quick Start Commands

T…ôtbiq etm…ôy…ô ba≈ülamaq √º√ß√ºn:

1. **Database function yaratmaq:**
   ```bash
   # Supabase dashboard > SQL Editor > yuxarƒ±dakƒ± SQL-i icra et
   # ‚úÖ TAMAMLANDI - get_assignable_users_for_region funksiyasƒ± yaradƒ±ldƒ±
   ```

2. **Backend service yenil…ônm…ôsi:**
   ```bash
   # userFetchService.ts faylƒ±nƒ± yenil…ô
   # ‚úÖ TAMAMLANDI - getAssignableUsersForRegion funksiyasƒ± …ôlav…ô edildi
   ```

3. **Test etm…ôk:**
   ```bash
   npm run dev
   # localhost:8080/sectors > Admin t…ôyin et
   # ‚úÖ HAZ/R - Test edilm…ôy…ô hazƒ±r
   ```

4. **Production Deploy:**
   ```bash
   # ‚úÖ HAZIR - B√ºt√ºn kodlar commit edilib, deploy edil…ô bil…ôr
   ```

---

## ‚ö†Ô∏è Risks & Mitigation

### Risk 1: Database Function Performance
**Risk:** B√∂y√ºk m…ôlumat bazasƒ±nda yava≈ü i≈ül…ôm…ô
**Mitigation:** ƒ∞ndeksl…ôr v…ô query optimization

### Risk 2: RLS Policy Conflicts  
**Risk:** M√∂vcud RLS siyas…ôtl…ôri il…ô konflikt
**Mitigation:** ∆ètraflƒ± test v…ô rollback planƒ±

### Risk 3: UI/UX Complexity
**Risk:** ƒ∞stifad…ô√ßi interfeysi √ßox m√ºr…ôkk…ôb olma
**Mitigation:** User grouping v…ô aydƒ±n kategoriyala≈üdƒ±rma

---

## üìû Support & Contact

Problem yarandƒ±qda v…ô ya sual olduqda bu planƒ± istinad olaraq istifad…ô edin.

**Next Step:** ‚úÖ TAMAMLANDI - Plan tam h…ôyata ke√ßirildi. Production deploy h…ô test edilm…ôy…ô hazƒ±r.
